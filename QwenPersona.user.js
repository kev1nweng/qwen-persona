// ==UserScript==
// @name         QwenPersona
// @namespace    https://www.kev1nweng.space
// @version      1764095119
// @description  Qwen Chat Custom Persona
// @author       Â∞èÁøÅÂêåÂ≠¶ (kev1nweng)
// @license      AGPL-3.0
// @match        https://chat.qwen.ai/*
// @updateURL    https://kev1nweng.github.io/qwen-persona/QwenPersona.user.js
// @downloadURL  https://kev1nweng.github.io/qwen-persona/QwenPersona.user.js
// @grant        none
// ==/UserScript==

!function(){"use strict";const e={PERSONAS:"qwen_personas",SELECTED:"qwen_selected_persona",MODELS_CACHE:"qwen_models_cache",CHAT_MAP:"qwen_chat_persona_map"},n={CONTAINER:"persona-dropdown-container",TRIGGER:"persona-trigger",MENU:"persona-dropdown-menu",MODAL_OVERLAY:"persona-modal-overlay",MODAL:"persona-modal",CREATE_BTN:"persona-create-btn",IMPORT_BTN:"persona-import-btn",SAVE_BTN:"persona-save-btn",STYLE_ID:"persona-manager-styles",INPUT_NAME:"persona-name-input",INPUT_EMOJI:"persona-emoji-input",INPUT_MODEL:"persona-model-input",INPUT_PROMPT:"persona-prompt-input",INPUT_DEEP_THINKING:"persona-deep-thinking-input",INPUT_WEB_SEARCH:"persona-web-search-input",HEADER_DESKTOP:".header-desktop",HEADER_LEFT:".header-desktop .header-content .header-left",MODEL_SELECTOR:'[class*="index-module__web-model-selector"]',MODEL_SELECTOR_CONTENT:'[class*="index-module__model-selector-content"]',MODEL_SELECTOR_DROPDOWN:'[class*="index-module__model-selector-dropdown"]',MODEL_SELECTOR_ITEM:'[class*="index-module__model-selector-item"]',MODEL_NAME_TEXT:'[class*="index-module__model-name-text"]',MODEL_SELECTOR_VIEW_MORE:'[class*="index-module__model-selector-view-more"]',MODEL_VIEW_MORE_TEXT:'[class*="index-module__view-more-text"]',ANT_DROPDOWN_TRIGGER:".ant-dropdown-trigger",CHAT_INPUT_FEATURE_BTN:".chat-input-feature-btn",CHAT_INPUT_FEATURE_TEXT:".chat-input-feature-btn-text",WEB_SEARCH_BTN:"button.websearch_button",TEXTAREA:"textarea",INPUT_CONTAINER:".chat-message-input-container-inner",TRIGGER_COLLAPSED:"collapsed",TRIGGER_ACTIVE:"active",MENU_VISIBLE:"visible",ARROW_OPEN:"open",ITEM_SELECTED:"selected",INPUT_DISABLED:"persona-input-disabled",INTERACTION_DISABLED:"persona-interaction-disabled",TRANSITION:"persona-input-transition",AGENT_ACTIVE:"persona-agent-active"},o={personas:[],selectedPersonaId:null,availableModels:[],dropdownVisible:!1,modalVisible:!1,editingPersona:null,lastUrl:location.href,chatPersonaMap:{}},t={locale:"en",translations:{en:{noPersona:"No Persona",selectPersona:"Select Persona",useDefaultSettings:"Use default settings",defaultModel:"Default Model",edit:"Edit",delete:"Delete",createPersona:"Create new Persona...",personaName:"Persona Name",namePlaceholder:"e.g. Coding Assistant, Translator...",icon:"Icon",model:"Model",useCurrentModel:"Use current model",modelHint:"Select the model for this Persona. Leave empty to use the current model.",systemPrompt:"System Prompt",promptPlaceholder:"Enter custom system prompt to define AI behavior and role...",promptHint:"This prompt will be injected as a system message, overriding default prompts.",features:"Features",deepThinking:"Deep Thinking",webSearch:"Web Search",featuresHint:"Enabled features will be automatically activated for each chat.",cancel:"Cancel",save:"Save",deleteConfirm:"Are you sure you want to delete this Persona?",editPersona:"Edit Persona",createNewPersona:"Create New Persona",importFromUrl:"Import from URL",enterUrl:"Enter the URL of the persona configuration JSON:",importSuccess:"Personas imported successfully!",importError:"Failed to import personas. Please check the URL and JSON format."},zh:{noPersona:"Êó† Persona",selectPersona:"ÈÄâÊã© Persona",useDefaultSettings:"‰ΩøÁî®ÈªòËÆ§ËÆæÁΩÆ",defaultModel:"ÈªòËÆ§Ê®°Âûã",edit:"ÁºñËæë",delete:"Âà†Èô§",createPersona:"ÂàõÂª∫Êñ∞ Persona...",personaName:"Persona ÂêçÁß∞",namePlaceholder:"‰æãÂ¶ÇÔºö‰ª£Á†ÅÂä©Êâã„ÄÅÁøªËØë‰∏ìÂÆ∂...",icon:"ÂõæÊ†á",model:"Ê®°Âûã",useCurrentModel:"‰ΩøÁî®ÂΩìÂâçÈÄâÊã©ÁöÑÊ®°Âûã",modelHint:"ÈÄâÊã©Ê≠§ Persona ‰ΩøÁî®ÁöÑÊ®°ÂûãÔºåÁïôÁ©∫Âàô‰ΩøÁî®È°µÈù¢ÂΩìÂâçÈÄâÊã©ÁöÑÊ®°Âûã",systemPrompt:"Á≥ªÁªüÊèêÁ§∫ËØç",promptPlaceholder:"ËæìÂÖ•Ëá™ÂÆö‰πâÁ≥ªÁªüÊèêÁ§∫ËØçÔºåÂÆö‰πâ AI ÁöÑË°å‰∏∫ÂíåËßíËâ≤...",promptHint:"Ê≠§ÊèêÁ§∫ËØçÂ∞Ü‰Ωú‰∏∫Á≥ªÁªüÊ∂àÊÅØÊ≥®ÂÖ•Âà∞ÂØπËØù‰∏≠Ôºå‰ºòÂÖà‰∫éÈªòËÆ§Á≥ªÁªüÊèêÁ§∫",features:"Â¢ûÂº∫ÂäüËÉΩ",deepThinking:"Ê∑±Â∫¶ÊÄùËÄÉ",webSearch:"ËÅîÁΩëÊêúÁ¥¢",featuresHint:"ÂêØÁî®ÂêéÂ∞ÜÂú®ÊØèÊ¨°ÂØπËØùÊó∂Ëá™Âä®ÂºÄÂêØÂØπÂ∫îÂäüËÉΩ",cancel:"ÂèñÊ∂à",save:"‰øùÂ≠ò",deleteConfirm:"Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ Persona ÂêóÔºü",editPersona:"ÁºñËæë Persona",createNewPersona:"ÂàõÂª∫Êñ∞ Persona",importFromUrl:"‰ªé URL ÂØºÂÖ•",enterUrl:"ËØ∑ËæìÂÖ• Persona ÈÖçÁΩÆ JSON ÁöÑ URLÔºö",importSuccess:"Persona ÂØºÂÖ•ÊàêÂäüÔºÅ",importError:"ÂØºÂÖ•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü• URL Âíå JSON Ê†ºÂºè„ÄÇ"}},init(){const e=navigator.language||navigator.userLanguage;this.locale=e.startsWith("zh")?"zh":"en"},t(e){return this.translations[this.locale]?.[e]||this.translations.en[e]||e}},r={escapeHtml(e){if(!e)return"";const n=document.createElement("div");return n.textContent=e,n.innerHTML},sleep:e=>new Promise(n=>setTimeout(n,e)),waitForElement:(e,n=2e3)=>new Promise(o=>{if(document.querySelector(e))return o(document.querySelector(e));const t=new MutationObserver(n=>{document.querySelector(e)&&(o(document.querySelector(e)),t.disconnect())});t.observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>{t.disconnect(),o(null)},n)})},a={loadPersonas(){try{const n=localStorage.getItem(e.PERSONAS);o.personas=n?JSON.parse(n):[]}catch(e){console.error("[QwenPersona] Failed to load personas:",e),o.personas=[]}},savePersonas(){try{localStorage.setItem(e.PERSONAS,JSON.stringify(o.personas))}catch(e){console.error("[QwenPersona] Failed to save personas:",e)}},loadSelectedPersona(){try{o.selectedPersonaId=localStorage.getItem(e.SELECTED)||null}catch(e){o.selectedPersonaId=null}},saveSelectedPersona(){try{o.selectedPersonaId?localStorage.setItem(e.SELECTED,o.selectedPersonaId):localStorage.removeItem(e.SELECTED)}catch(e){console.error("[QwenPersona] Failed to save selected persona:",e)}},loadChatPersonaMap(){try{const n=localStorage.getItem(e.CHAT_MAP);o.chatPersonaMap=n?JSON.parse(n):{}}catch(e){o.chatPersonaMap={}}},saveChatPersonaMap(){try{localStorage.setItem(e.CHAT_MAP,JSON.stringify(o.chatPersonaMap))}catch(e){console.error("[QwenPersona] Failed to save chat persona map:",e)}}},s={injectStyles(){const e=document.createElement("style");e.id=n.STYLE_ID,e.textContent="\n            /* Persona Dropdown Container */\n            .persona-dropdown-container {\n                position: relative;\n                display: flex;\n                align-items: center;\n                margin-left: 6px;\n                z-index: 100;\n            }\n\n            /* Transition Helper */\n            .persona-input-transition {\n                transition: filter 0.3s ease, opacity 0.3s ease;\n            }\n\n            /* Disabled Input State */\n            .persona-input-disabled {\n                filter: grayscale(100%);\n                opacity: 0.7;\n                pointer-events: none;\n                cursor: not-allowed;\n                position: relative;\n            }\n\n            .persona-input-disabled::after {\n                content: \"\";\n                position: absolute;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                z-index: 10;\n                border-radius: inherit;\n            }\n\n            /* Persona Trigger Button */\n            .persona-trigger {\n                display: flex;\n                align-items: center;\n              justify-content: flex-start;\n              gap: 8px;\n              width: var(--persona-trigger-expanded-width, 10rem);\n              min-width: 36px;\n              height: 36px;\n              padding: 0 12px;\n              box-sizing: border-box;\n              border-radius: 999px;\n              background: var(--container-secondary-fill, #f7f8fc);\n              cursor: pointer;\n              border: 1px solid var(--line-secondary-border, #e0e2eb);\n              font-size: 14px;\n              color: var(--character-primary-text, #2c2c36);\n              overflow: hidden;\n              transition:\n                width 0.5s cubic-bezier(0.22, 1, 0.36, 1),\n                padding 0.5s cubic-bezier(0.22, 1, 0.36, 1),\n                gap 0.5s cubic-bezier(0.22, 1, 0.36, 1),\n                background 0.2s ease,\n                border 0.2s ease,\n                color 0.2s ease,\n                filter 0.3s ease,\n                opacity 0.3s ease;\n            }\n\n            /* Collapsed State (Circular) */\n            .persona-trigger.collapsed {\n              width: 36px;\n              padding: 0;\n              justify-content: center;\n              background: transparent;\n              gap: 0;\n              margin-right: 4px;\n            }\n\n            .persona-trigger.collapsed:hover {\n                background: var(--container-secondary-fill, #f7f8fc);\n            }\n\n            .persona-trigger.collapsed .persona-trigger-text,\n            .persona-trigger.collapsed .persona-trigger-arrow {\n                opacity: 0;\n                width: 0;\n                margin: 0;\n                pointer-events: none;\n            }\n\n            .persona-trigger.collapsed .persona-trigger-icon {\n              margin: 0;\n              font-size: 20px;\n              width: 100%;\n              height: 100%;\n              justify-content: center;\n            }\n\n            .persona-trigger:hover {\n                background: var(--container-tertiary-fill, #eef0f5);\n            }\n\n            .persona-trigger.active {\n                border-color: var(--btn-brandprimary-fill, #615ced);\n                background: var(--container-brandquinary-fill, #eeedff);\n            }\n\n            .persona-trigger-icon {\n              font-size: 18px;\n              flex-shrink: 0;\n              width: 24px;\n              height: 24px;\n              display: flex;\n              align-items: center;\n              justify-content: center;\n              line-height: 1;\n            }\n\n            .persona-trigger-text {\n                overflow: hidden;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n                flex: 1;\n                transition: opacity 0.2s ease, width 0.2s ease;\n            }\n\n            .persona-trigger-arrow {\n                font-size: 16px;\n                transition: transform 0.2s ease, opacity 0.2s ease, width 0.2s ease;\n                flex-shrink: 0;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transform-origin: center;\n            }\n\n            .persona-trigger-arrow.open {\n                transform: rotate(180deg);\n            }\n\n            /* Dropdown Menu */\n            .persona-dropdown-menu {\n                position: fixed;\n                min-width: 240px;\n                max-width: 320px;\n                background: var(--container-primary-fill, #fff);\n                border-radius: 16px;\n                box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);\n                border: 1px solid var(--line-secondary-border, #e0e2eb);\n                z-index: 99999;\n                opacity: 0;\n                transform: translateY(-8px);\n                pointer-events: none;\n                transition: opacity 0.2s ease, transform 0.2s ease;\n                overflow: visible;\n            }\n\n            .persona-dropdown-menu.visible {\n                opacity: 1;\n                transform: translateY(0);\n                pointer-events: auto;\n            }\n\n            .persona-dropdown-header {\n                padding: 12px 16px;\n                font-size: 12px;\n                font-weight: 500;\n                color: var(--character-tertiary-text, #8f91a8);\n                border-bottom: 1px solid var(--line-secondary-border, #e0e2eb);\n            }\n\n            .persona-dropdown-list {\n                max-height: 66vh;\n                overflow-y: auto;\n                padding: 0 8px;\n            }\n\n            .persona-dropdown-item {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                padding: 10px 12px;\n                cursor: pointer !important;\n                border-radius: 12px;\n                transition: all 0.15s ease;\n                margin: 8px 0;\n                user-select: none;\n            }\n\n            .persona-dropdown-item:hover {\n                background: var(--container-secondary-fill, #f7f8fc) !important;\n            }\n\n            .persona-dropdown-item.selected {\n                background: var(--container-brandquinary-fill, #eeedff);\n            }\n\n            .persona-dropdown-item.selected:hover {\n                background: var(--container-brandquinary-fill, #eeedff) !important;\n            }\n\n            .persona-dropdown-item-icon {\n                width: 32px;\n                height: 32px;\n                border-radius: 8px;\n                background: var(--container-tertiary-fill, #eef0f5);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 16px;\n                flex-shrink: 0;\n            }\n\n            .persona-dropdown-item.selected .persona-dropdown-item-icon {\n                background: var(--btn-brandprimary-fill, #615ced);\n                color: white;\n            }\n\n            .persona-dropdown-item-content {\n                flex: 1;\n                overflow: hidden;\n            }\n\n            .persona-dropdown-item-name {\n                font-size: 14px;\n                font-weight: 500;\n                color: var(--character-primary-text, #2c2c36);\n                overflow: hidden;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n            }\n\n            .persona-dropdown-item-model {\n                font-size: 12px;\n                color: var(--character-tertiary-text, #8f91a8);\n                overflow: hidden;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n            }\n\n            .persona-dropdown-item-actions {\n                display: flex;\n                gap: 4px;\n                opacity: 0;\n                transition: opacity 0.15s ease;\n            }\n\n            .persona-dropdown-item:hover .persona-dropdown-item-actions {\n                opacity: 1;\n            }\n\n            .persona-action-btn {\n                width: 24px;\n                height: 24px;\n                border-radius: 6px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                cursor: pointer;\n                transition: all 0.15s ease;\n                color: var(--character-tertiary-text, #8f91a8);\n            }\n\n            .persona-action-btn:hover {\n                background: var(--container-tertiary-fill, #eef0f5);\n                color: var(--character-primary-text, #2c2c36);\n            }\n\n            .persona-action-btn.delete:hover {\n                background: #fee2e2;\n                color: #dc2626;\n            }\n\n            .persona-dropdown-divider {\n                height: 1px;\n                background: var(--line-secondary-border, #e0e2eb);\n            }\n\n            .persona-dropdown-footer {\n                padding: 4px;\n            }\n\n            .persona-create-btn {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                padding: 10px 12px;\n                cursor: pointer !important;\n                border-radius: 12px;\n                transition: all 0.15s ease;\n                color: var(--btn-brandprimary-fill, #615ced);\n                font-size: 14px;\n                font-weight: 500;\n                user-select: none;\n            }\n\n            .persona-create-btn:hover {\n                background: var(--container-brandquinary-fill, #eeedff) !important;\n            }\n\n            /* Modal Styles */\n            .persona-modal-overlay {\n                position: fixed;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                background: rgba(0, 0, 0, 0.5);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                z-index: 100000;\n                opacity: 0;\n                pointer-events: none;\n                transition: opacity 0.2s ease;\n            }\n\n            .persona-modal-overlay.visible {\n                opacity: 1;\n                pointer-events: auto;\n            }\n\n            .persona-modal {\n                background: var(--container-primary-fill, #fff);\n                border-radius: 20px;\n                width: 480px;\n                max-width: 90vw;\n                max-height: 90vh;\n                overflow: hidden;\n                transform: scale(0.95);\n                transition: transform 0.2s ease;\n            }\n\n            .persona-modal-overlay.visible .persona-modal {\n                transform: scale(1);\n            }\n\n            .persona-modal-header {\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                padding: 20px 24px;\n                border-bottom: 1px solid var(--line-secondary-border, #e0e2eb);\n            }\n\n            .persona-modal-title {\n                font-size: 18px;\n                font-weight: 600;\n                color: var(--character-primary-text, #2c2c36);\n            }\n\n            .persona-modal-close {\n                width: 32px;\n                height: 32px;\n                border-radius: 8px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                cursor: pointer;\n                transition: all 0.15s ease;\n                color: var(--character-tertiary-text, #8f91a8);\n            }\n\n            .persona-modal-close:hover {\n                background: var(--container-secondary-fill, #f7f8fc);\n            }\n\n            .persona-modal-body {\n                padding: 24px;\n                overflow-y: auto;\n                max-height: calc(90vh - 180px);\n            }\n\n            .persona-form-group {\n                margin-bottom: 20px;\n            }\n\n            .persona-form-label {\n                display: block;\n                font-size: 14px;\n                font-weight: 500;\n                color: var(--character-primary-text, #2c2c36);\n                margin-bottom: 8px;\n            }\n\n            .persona-form-input {\n                width: 100%;\n                padding: 12px 16px;\n                border: 1px solid var(--line-secondary-border, #e0e2eb);\n                border-radius: 12px;\n                font-size: 14px;\n                color: var(--character-primary-text, #2c2c36);\n                background: var(--container-primary-fill, #fff);\n                transition: all 0.15s ease;\n                box-sizing: border-box;\n            }\n\n            .persona-form-input:focus {\n                outline: none;\n                border-color: var(--btn-brandprimary-fill, #615ced);\n                box-shadow: 0 0 0 3px rgba(97, 92, 237, 0.1);\n            }\n\n            .persona-form-textarea {\n                resize: vertical;\n                min-height: 120px;\n                font-family: inherit;\n                line-height: 1.5;\n            }\n\n            .persona-form-select {\n                appearance: none;\n                background-image: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%238f91a8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E\");\n                background-repeat: no-repeat;\n                background-position: right 12px center;\n                padding-right: 40px;\n            }\n\n            .persona-form-hint {\n                font-size: 12px;\n                color: var(--character-tertiary-text, #8f91a8);\n                margin-top: 6px;\n            }\n\n            .persona-modal-footer {\n                display: flex;\n                gap: 12px;\n                padding: 20px 24px;\n                border-top: 1px solid var(--line-secondary-border, #e0e2eb);\n            }\n\n            .persona-btn {\n                flex: 1;\n                padding: 12px 24px;\n                border-radius: 999px;\n                font-size: 14px;\n                font-weight: 500;\n                cursor: pointer;\n                transition: all 0.15s ease;\n                border: none;\n            }\n\n            .persona-btn-secondary {\n                background: var(--container-secondary-fill, #f7f8fc);\n                color: var(--character-primary-text, #2c2c36);\n            }\n\n            .persona-btn-secondary:hover {\n                background: var(--container-tertiary-fill, #eef0f5);\n            }\n\n            .persona-btn-primary {\n                background: var(--btn-brandprimary-fill, #615ced);\n                color: white;\n            }\n\n            .persona-btn-primary:hover {\n                background: #5248d9;\n            }\n\n            .persona-btn-primary:disabled {\n                opacity: 0.5;\n                cursor: not-allowed;\n            }\n\n            /* Dark mode adjustments */\n            html.dark .persona-trigger {\n                background: var(--container-secondary-fill, #2a2a2a);\n            }\n\n            html.dark .persona-trigger:hover {\n                background: var(--container-tertiary-fill, #3a3a3a);\n            }\n\n            html.dark .persona-dropdown-menu {\n                background: var(--container-primary-fill, #1f1f1f);\n                border-color: var(--line-secondary-border, #424554);\n            }\n\n            html.dark .persona-modal {\n                background: var(--container-primary-fill, #1f1f1f);\n            }\n\n            html.dark .persona-form-input {\n                background: var(--container-secondary-fill, #2a2a2a);\n                border-color: var(--line-secondary-border, #424554);\n            }\n\n            /* Animation */\n            @keyframes persona-pulse {\n                0%, 100% { opacity: 1; }\n                50% { opacity: 0.7; }\n            }\n\n            .persona-indicator {\n                width: 6px;\n                height: 6px;\n                border-radius: 50%;\n                background: var(--btn-brandprimary-fill, #615ced);\n                animation: persona-pulse 2s ease-in-out infinite;\n            }\n\n            /* Scrollbar styling */\n            .persona-dropdown-list::-webkit-scrollbar {\n                width: 6px;\n            }\n\n            .persona-dropdown-list::-webkit-scrollbar-track {\n                background: transparent;\n            }\n\n            .persona-dropdown-list::-webkit-scrollbar-thumb {\n                background: var(--line-secondary-border, #e0e2eb);\n                border-radius: 3px;\n            }\n\n            .persona-dropdown-list::-webkit-scrollbar-thumb:hover {\n                background: var(--character-quaternary-text, #c8cad9);\n            }\n\n            /* Checkbox group styling */\n            .persona-form-checkbox-group {\n                display: flex;\n                gap: 24px;\n                flex-wrap: wrap;\n            }\n\n            .persona-form-checkbox-item {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                cursor: pointer;\n                user-select: none;\n            }\n\n            .persona-form-checkbox {\n                width: 18px;\n                height: 18px;\n                border: 2px solid var(--line-secondary-border, #e0e2eb);\n                border-radius: 4px;\n                appearance: none;\n                cursor: pointer;\n                position: relative;\n                transition: all 0.15s ease;\n                background: var(--container-primary-fill, #fff);\n            }\n\n            .persona-form-checkbox:checked {\n                background: var(--btn-brandprimary-fill, #615ced);\n                border-color: var(--btn-brandprimary-fill, #615ced);\n            }\n\n            .persona-form-checkbox:checked::after {\n                content: '';\n                position: absolute;\n                left: 5px;\n                top: 2px;\n                width: 4px;\n                height: 8px;\n                border: solid white;\n                border-width: 0 2px 2px 0;\n                transform: rotate(45deg);\n            }\n\n            .persona-form-checkbox:focus {\n                outline: none;\n                box-shadow: 0 0 0 3px rgba(97, 92, 237, 0.1);\n            }\n\n            .persona-form-checkbox-label {\n                font-size: 14px;\n                color: var(--character-primary-text, #2c2c36);\n            }\n\n            /* Feature badges in dropdown */\n            .persona-dropdown-item-features {\n                display: flex;\n                gap: 4px;\n                margin-top: 2px;\n            }\n\n            .persona-feature-badge {\n                font-size: 10px;\n                padding: 1px 6px;\n                border-radius: 4px;\n                background: var(--container-tertiary-fill, #eef0f5);\n                color: var(--character-tertiary-text, #8f91a8);\n            }\n\n            .persona-feature-badge.active {\n                background: var(--container-brandquinary-fill, #eeedff);\n                color: var(--btn-brandprimary-fill, #615ced);\n            }\n\n            /* Adjust model selector margin */\n            [class*=\"index-module__web-model-selector\"] {\n                margin-left: 0;\n            }\n\n            /* Hide native model selector when agent is active */\n            body.persona-agent-active [class*=\"index-module__web-model-selector\"] {\n                display: none !important;\n            }\n\n            /* Hide the \"ËÆæ‰∏∫ÈªòËÆ§/ÂèñÊ∂àÈªòËÆ§\" button when agent is active */\n            /* This might need adjustment based on new structure, but usually it's near the selector */\n            body.persona-agent-active [class*=\"index-module__add-model-icon\"] {\n                display: none !important;\n            }\n\n            /* Adjust navbar layout when model selector is hidden */\n            body.persona-agent-active .persona-dropdown-container {\n                margin-left: 0;\n                margin-right: 16px;\n            }\n\n            /* Emoji Picker Styles */\n            .persona-emoji-wrapper {\n                position: relative;\n            }\n\n            .persona-emoji-trigger {\n                font-size: 24px;\n                width: 48px;\n                height: 48px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                border: 1px solid var(--line-secondary-border, #e0e2eb);\n                border-radius: 12px;\n                cursor: pointer;\n                background: var(--container-primary-fill, #fff);\n                transition: all 0.15s ease;\n            }\n\n            .persona-emoji-trigger:hover {\n                background: var(--container-secondary-fill, #f7f8fc);\n                border-color: var(--btn-brandprimary-fill, #615ced);\n            }\n\n            .persona-emoji-picker-container {\n                position: absolute;\n                top: 100%;\n                left: 0;\n                z-index: 100;\n                margin-top: 8px;\n                box-shadow: 0 8px 24px rgba(0,0,0,0.15);\n                border: 1px solid var(--line-secondary-border, #e0e2eb);\n                border-radius: 12px;\n                overflow: hidden;\n                display: none;\n                width: 380px;\n                max-width: 90vw;\n            }\n\n            .persona-emoji-picker-container.visible {\n                display: block;\n            }\n\n            emoji-picker {\n                --background: var(--container-primary-fill, #fff);\n                --border-color: var(--line-secondary-border, #e0e2eb);\n                --input-border-color: var(--line-secondary-border, #e0e2eb);\n                --input-font-color: var(--character-primary-text, #2c2c36);\n                --button-hover-background: var(--container-secondary-fill, #f7f8fc);\n                width: 100%;\n                height: 320px;\n            }\n\n            html.dark emoji-picker {\n                --background: #1f1f1f;\n                --border-color: #424554;\n                --input-border-color: #424554;\n                --input-font-color: #e0e2eb;\n                --button-hover-background: #2a2a2a;\n            }\n      ",document.head.appendChild(e)},createDropdownUI(){const e=document.createElement("div");e.className="persona-dropdown-container",e.id=n.CONTAINER;const r=document.createElement("div");if(r.className=`persona-trigger ${n.TRIGGER_COLLAPSED}`,r.id=n.TRIGGER,r.innerHTML=`\n            <span class="persona-trigger-icon">ü§ñ</span>\n            <span class="persona-trigger-text">${t.t("noPersona")}</span>\n            <span class="persona-trigger-arrow">\n                <svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false"><use xlink:href="#icon-line-chevron-down"></use></svg>\n            </span>\n        `,r.onclick=e=>{e.stopPropagation(),s.toggleDropdown()},r.addEventListener("mouseenter",()=>{r.classList.remove(n.TRIGGER_COLLAPSED)}),r.addEventListener("mouseleave",()=>{o.selectedPersonaId||o.dropdownVisible||r.classList.add(n.TRIGGER_COLLAPSED)}),e.appendChild(r),!document.getElementById(n.MENU)){const e=document.createElement("div");e.className="persona-dropdown-menu",e.id=n.MENU,document.body.appendChild(e)}return e},renderDropdownMenu(){const e=document.getElementById(n.MENU);if(!e)return;let a=`\n            <div class="persona-dropdown-header">${t.t("selectPersona")}</div>\n            <div class="persona-dropdown-list">\n                <div class="persona-dropdown-item ${o.selectedPersonaId?"":n.ITEM_SELECTED}" data-id="">\n                    <div class="persona-dropdown-item-icon">üö´</div>\n                    <div class="persona-dropdown-item-content">\n                        <div class="persona-dropdown-item-name">${t.t("noPersona")}</div>\n                        <div class="persona-dropdown-item-model">${t.t("useDefaultSettings")}</div>\n                    </div>\n                </div>\n        `;o.personas.forEach(e=>{let s="";(e.deepThinking||e.webSearch)&&(s='<div class="persona-dropdown-item-features">',e.deepThinking&&(s+='<span class="persona-feature-badge active">Ê∑±Â∫¶ÊÄùËÄÉ</span>'),e.webSearch&&(s+='<span class="persona-feature-badge active">ËÅîÁΩë</span>'),s+="</div>"),a+=`\n                <div class="persona-dropdown-item ${e.id===o.selectedPersonaId?n.ITEM_SELECTED:""}" data-id="${e.id}">\n                    <div class="persona-dropdown-item-icon">${e.emoji||"üö´"}</div>\n                    <div class="persona-dropdown-item-content">\n                        <div class="persona-dropdown-item-name">${r.escapeHtml(e.name)}</div>\n                        <div class="persona-dropdown-item-model">${r.escapeHtml(e.modelName||e.model||t.t("defaultModel"))}</div>\n                        ${s}\n                    </div>\n                    <div class="persona-dropdown-item-actions">\n                        <div class="persona-action-btn edit" data-action="edit" data-id="${e.id}" title="${t.t("edit")}">\n                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>\n                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>\n                            </svg>\n                        </div>\n                        <div class="persona-action-btn delete" data-action="delete" data-id="${e.id}" title="${t.t("delete")}">\n                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                                <polyline points="3 6 5 6 21 6"></polyline>\n                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>\n                                <line x1="10" y1="11" x2="10" y2="17"></line>\n                                <line x1="14" y1="11" x2="14" y2="17"></line>\n                            </svg>\n                        </div>\n                    </div>\n                </div>\n            `}),a+=`\n            </div>\n            <div class="persona-dropdown-divider"></div>\n            <div class="persona-dropdown-footer">\n                <div class="persona-create-btn" id="${n.CREATE_BTN}">\n                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                        <line x1="12" y1="5" x2="12" y2="19"></line>\n                        <line x1="5" y1="12" x2="19" y2="12"></line>\n                    </svg>\n                    <span>${t.t("createPersona")}</span>\n                </div>\n                <div class="persona-create-btn" id="${n.IMPORT_BTN}" style="margin-top: 4px;">\n                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>\n                        <polyline points="7 10 12 15 17 10"></polyline>\n                        <line x1="12" y1="15" x2="12" y2="3"></line>\n                    </svg>\n                    <span>${t.t("importFromUrl")}</span>\n                </div>\n            </div>\n        `,e.innerHTML=a,e.querySelectorAll(".persona-dropdown-item").forEach(e=>{e.addEventListener("click",n=>{if(n.preventDefault(),n.stopPropagation(),n.target.closest(".persona-action-btn"))return;const o=e.dataset.id;console.log("[QwenPersona] Item clicked, id:",o),c.selectPersona(o||null)})}),e.querySelectorAll(".persona-action-btn").forEach(e=>{e.addEventListener("click",n=>{n.preventDefault(),n.stopPropagation();const o=e.dataset.action,t=e.dataset.id;console.log("[QwenPersona] Action clicked:",o,t),"edit"===o?c.editPersona(t):"delete"===o&&c.deletePersona(t)})});const i=document.getElementById(n.CREATE_BTN);i&&i.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),console.log("[QwenPersona] Create button clicked"),s.openModal()});const l=document.getElementById(n.IMPORT_BTN);l&&l.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),console.log("[QwenPersona] Import button clicked");const n=prompt(t.t("enterUrl"));n&&c.importFromUrl(n)})},updateTriggerUI(){const e=document.getElementById(n.TRIGGER);if(!e)return;const r=o.personas.find(e=>e.id===o.selectedPersonaId),a=e.querySelector(".persona-trigger-icon"),s=e.querySelector(".persona-trigger-text");r?(e.classList.remove(n.TRIGGER_COLLAPSED),e.classList.add(n.TRIGGER_ACTIVE),a.textContent=r.emoji||"üö´",s.textContent=r.name,r.model?document.body.classList.add(n.AGENT_ACTIVE):document.body.classList.remove(n.AGENT_ACTIVE)):(e.classList.add(n.TRIGGER_COLLAPSED),e.classList.remove(n.TRIGGER_ACTIVE),a.textContent="ü§ñ",s.textContent=t.t("noPersona"),document.body.classList.remove(n.AGENT_ACTIVE))},createModalUI(){const e=document.createElement("div");e.className="persona-modal-overlay",e.id=n.MODAL_OVERLAY,e.onclick=n=>{n.target===e&&s.closeModal()};const o=document.createElement("div");o.className="persona-modal",o.id=n.MODAL,e.appendChild(o),document.body.appendChild(e)},renderModal(e=null){const a=document.getElementById(n.MODAL);if(!a)return;const s=!!e?t.t("editPersona"):t.t("createNewPersona");let i="";o.availableModels.forEach(n=>{const o=e&&e.model===n.id?"selected":"";i+=`<option value="${n.id}" ${o}>${n.name||n.id}</option>`}),a.innerHTML=`\n            <div class="persona-modal-header">\n                <div class="persona-modal-title">${s}</div>\n                <div class="persona-modal-close" onclick="window.personaManager.closeModal()">\n                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                        <line x1="18" y1="6" x2="6" y2="18"></line>\n                        <line x1="6" y1="6" x2="18" y2="18"></line>\n                    </svg>\n                </div>\n            </div>\n            <div class="persona-modal-body">\n                <div class="persona-form-group">\n                    <label class="persona-form-label">${t.t("personaName")}</label>\n                    <input type="text" class="persona-form-input" id="${n.INPUT_NAME}"\n                           value="${e?r.escapeHtml(e.name):""}"\n                           placeholder="${t.t("namePlaceholder")}">\n                </div>\n                <div class="persona-form-group">\n                    <label class="persona-form-label">${t.t("icon")}</label>\n                    <div class="persona-emoji-wrapper">\n                        <button class="persona-emoji-trigger" id="persona-emoji-trigger-btn">\n                            ${e?e.emoji:"ü§ñ"}\n                        </button>\n                        <input type="hidden" id="${n.INPUT_EMOJI}" value="${e?e.emoji:"ü§ñ"}">\n                        <div class="persona-emoji-picker-container" id="persona-emoji-picker">\n                            <emoji-picker></emoji-picker>\n                        </div>\n                    </div>\n                </div>\n                <div class="persona-form-group">\n                    <label class="persona-form-label">${t.t("model")}</label>\n                    <select class="persona-form-input persona-form-select" id="${n.INPUT_MODEL}">\n                        <option value="">${t.t("useCurrentModel")}</option>\n                        ${i}\n                    </select>\n                    <div class="persona-form-hint">${t.t("modelHint")}</div>\n                </div>\n                <div class="persona-form-group">\n                    <label class="persona-form-label">${t.t("systemPrompt")}</label>\n                    <textarea class="persona-form-input persona-form-textarea" id="${n.INPUT_PROMPT}"\n                              placeholder="${t.t("promptPlaceholder")}">${e?r.escapeHtml(e.prompt):""}</textarea>\n                    <div class="persona-form-hint">${t.t("promptHint")}</div>\n                </div>\n                <div class="persona-form-group">\n                    <label class="persona-form-label">${t.t("features")}</label>\n                    <div class="persona-form-checkbox-group">\n                        <label class="persona-form-checkbox-item">\n                            <input type="checkbox" class="persona-form-checkbox" id="${n.INPUT_DEEP_THINKING}"\n                                   ${e&&e.deepThinking?"checked":""}>\n                            <span class="persona-form-checkbox-label">${t.t("deepThinking")}</span>\n                        </label>\n                        <label class="persona-form-checkbox-item">\n                            <input type="checkbox" class="persona-form-checkbox" id="${n.INPUT_WEB_SEARCH}"\n                                   ${e&&e.webSearch?"checked":""}>\n                            <span class="persona-form-checkbox-label">${t.t("webSearch")}</span>\n                        </label>\n                    </div>\n                    <div class="persona-form-hint">${t.t("featuresHint")}</div>\n                </div>\n            </div>\n            <div class="persona-modal-footer">\n                <button class="persona-btn persona-btn-secondary" onclick="window.personaManager.closeModal()">${t.t("cancel")}</button>\n                <button class="persona-btn persona-btn-primary" id="${n.SAVE_BTN}">${t.t("save")}</button>\n            </div>\n        `;const l=document.getElementById("persona-emoji-trigger-btn"),d=document.getElementById(n.INPUT_EMOJI),p=document.getElementById("persona-emoji-picker"),m=p?p.querySelector("emoji-picker"):null;l&&p&&(l.onclick=e=>{e.stopPropagation(),p.classList.toggle("visible")}),m&&("zh"===t.locale&&(m.dataSource="https://cdn.jsdelivr.net/npm/emoji-picker-element-data@^1/zh/cldr/data.json",m.locale="zh"),m.addEventListener("emoji-click",e=>{const n=e.detail.unicode;l.textContent=n,d.value=n,p.classList.remove("visible")})),document.getElementById(n.SAVE_BTN).onclick=()=>c.savePersonaFromModal(e?.id)},toggleDropdown(){o.dropdownVisible=!o.dropdownVisible;const e=document.getElementById(n.TRIGGER),t=document.getElementById(n.MENU),r=document.querySelector(".persona-trigger-arrow");if(o.dropdownVisible){if(e.classList.remove(n.TRIGGER_COLLAPSED),s.renderDropdownMenu(),e&&t){const n=e.getBoundingClientRect();t.style.top=n.bottom+8+"px",t.style.left=n.left+"px",console.log("[QwenPersona] Dropdown position:",{top:t.style.top,left:t.style.left,rect:n})}else console.warn("[QwenPersona] Missing elements:",{trigger:!!e,menu:!!t});t.classList.add(n.MENU_VISIBLE),r&&r.classList.add(n.ARROW_OPEN),console.log("[QwenPersona] Dropdown opened, menu classes:",t.className)}else o.selectedPersonaId||e.classList.add(n.TRIGGER_COLLAPSED),t.classList.remove(n.MENU_VISIBLE),r&&r.classList.remove(n.ARROW_OPEN),console.log("[QwenPersona] Dropdown closed")},closeDropdown(){o.dropdownVisible=!1;const e=document.getElementById(n.TRIGGER),t=document.getElementById(n.MENU),r=document.querySelector(".persona-trigger-arrow");e&&!o.selectedPersonaId&&e.classList.add(n.TRIGGER_COLLAPSED),t&&t.classList.remove(n.MENU_VISIBLE),r&&r.classList.remove(n.ARROW_OPEN)},openModal(e=null){o.editingPersona=e,s.closeDropdown(),s.renderModal(e);const t=document.getElementById(n.MODAL_OVERLAY);t&&(t.classList.add(n.MENU_VISIBLE),o.modalVisible=!0)},closeModal(){const e=document.getElementById(n.MODAL_OVERLAY);e&&(e.classList.remove(n.MENU_VISIBLE),o.modalVisible=!1),o.editingPersona=null},setInteractionState(e){const o=document.getElementById(n.TRIGGER);o&&(e?o.classList.add(n.INPUT_DISABLED):o.classList.remove(n.INPUT_DISABLED));document.querySelectorAll(n.TEXTAREA).forEach(o=>{const t=o.closest(n.INPUT_CONTAINER)||o.parentElement;t&&t.classList.add(n.TRANSITION),e?o.disabled||(o.dataset.originalPlaceholder=o.placeholder||"",o.placeholder="Ê≠£Âú®ÂàáÊç¢ Persona...",o.disabled=!0,o.classList.add(n.INTERACTION_DISABLED),t&&t.classList.add(n.INPUT_DISABLED)):o.disabled&&o.classList.contains(n.INTERACTION_DISABLED)&&(o.disabled=!1,o.placeholder=o.dataset.originalPlaceholder||"",o.classList.remove(n.INTERACTION_DISABLED),t&&t.classList.remove(n.INPUT_DISABLED))})},waitForNavbar(){let e=0;const o=()=>{const t=document.querySelector(n.HEADER_LEFT);if(t&&!document.getElementById(n.CONTAINER)){const e=t.querySelector(n.MODEL_SELECTOR),o=s.createDropdownUI();return e?t.insertBefore(o,e):t.appendChild(o),s.updateTriggerUI(),console.log("[QwenPersona] UI injected"),void c.autoSelectPersonaForChat()}e++,e<50?setTimeout(o,200):console.warn("[QwenPersona] Failed to find navbar after",50,"attempts")};o()}},i={async fetchModels(){try{const n=await fetch("/api/models",{method:"GET",headers:{Accept:"application/json",source:"web"}});if(n.ok){const t=await n.json();o.availableModels=t.data||t||[],localStorage.setItem(e.MODELS_CACHE,JSON.stringify(o.availableModels)),console.log("[QwenPersona] Models loaded:",o.availableModels.length)}}catch(n){console.error("[QwenPersona] Failed to fetch models:",n);try{const n=localStorage.getItem(e.MODELS_CACHE);n&&(o.availableModels=JSON.parse(n))}catch(e){}}},async simulateModelSelection(e){if(!e)return!1;console.log("[QwenPersona] Attempting to select model via UI:",e);const o=document.createElement("style");o.id="persona-hide-model-selector",o.textContent=`\n            ${n.MODEL_SELECTOR_DROPDOWN},\n            .ant-dropdown,\n            .ant-select-dropdown {\n                opacity: 0 !important;\n                pointer-events: none !important;\n                visibility: hidden !important;\n                display: none !important;\n                transition: none !important;\n                animation: none !important;\n            }\n        `,document.head.appendChild(o);try{const o=document.querySelector(n.MODEL_SELECTOR_CONTENT);if(!o)return console.warn("[QwenPersona] Model selector trigger content not found"),!1;const t=o.closest(n.ANT_DROPDOWN_TRIGGER);if(!t)return console.warn("[QwenPersona] Model selector trigger not found"),!1;t.click(),console.log("[QwenPersona] Clicked model selector trigger");const a=n.MODEL_SELECTOR_DROPDOWN;let s=await r.waitForElement(a,2e3);if(!s)return console.warn("[QwenPersona] Model selector menu not found"),!1;let l=i.findModelButton(s,e);if(!l){const o=s.querySelector(n.MODEL_SELECTOR_VIEW_MORE);if(console.log("[QwenPersona] Expand button:",o),o){const t=o.querySelector(n.MODEL_VIEW_MORE_TEXT),d=(t?t.textContent:"").includes("ÊäòÂè†");console.log("[QwenPersona] Menu expanded state:",d),d||(console.log("[QwenPersona] Clicking expand button..."),o.click(),await r.sleep(400),s=document.querySelector(a),s&&(l=i.findModelButton(s,e)))}else console.log("[QwenPersona] No expand button found in menu")}if(l){const o=l.closest(n.MODEL_SELECTOR_ITEM);return o&&Array.from(o.classList).some(e=>e.includes("index-module__model-selector-item-selected"))?(console.log("[QwenPersona] Model already selected:",e),i.closeModelSelector(),!0):(l.click(),console.log("[QwenPersona] Clicked model button:",e),!0)}return console.warn("[QwenPersona] Model button not found for:",e),i.closeModelSelector(),!1}catch(e){return console.error("[QwenPersona] Error selecting model:",e),!1}finally{await r.sleep(50);const e=document.getElementById("persona-hide-model-selector");e&&e.remove()}},findModelButton(e,o){const t=e.querySelectorAll(n.MODEL_SELECTOR_ITEM);console.log("[QwenPersona] Looking for model:",o,"in",t.length,"items");const r=o.toLowerCase().replace(/[-_]/g,"");for(const e of t){const o=e.querySelector(n.MODEL_NAME_TEXT);if(o){const n=o.textContent.trim(),t=n.toLowerCase().replace(/[-_]/g,"");if(t===r)return console.log("[QwenPersona] Found exact match:",n),e;if(r.includes(t)||t.includes(r))return console.log("[QwenPersona] Found partial match:",n),e}}for(const e of t){const t=e.querySelector(n.MODEL_NAME_TEXT);if(t){const n=t.textContent.trim();if(o.split("-").slice(0,2).join("-").toLowerCase()===n.split("-").slice(0,2).join("-").toLowerCase())return console.log("[QwenPersona] Found loose match:",n),e}}return console.log("[QwenPersona] No match found for:",o),null},closeModelSelector(){document.dispatchEvent(new KeyboardEvent("keydown",{key:"Escape",code:"Escape",keyCode:27,which:27,bubbles:!0})),setTimeout(()=>{const e=document.querySelector(".selector-modal-list")?.closest(".fixed");if(e){const e=new MouseEvent("click",{bubbles:!0,cancelable:!0});document.body.dispatchEvent(e)}},50)}},l={findDeepThinkingButton(){const e=document.querySelectorAll(n.CHAT_INPUT_FEATURE_BTN);for(const n of e){const e=n.querySelector("use");if(e&&e.getAttribute("xlink:href")?.includes("icon-line-deepthink-01"))return n;if(n.querySelector(".icon-line-deepthink-01"))return n}for(const o of e){const e=o.querySelector(n.CHAT_INPUT_FEATURE_TEXT);if(e&&e.textContent.includes("Ê∑±Â∫¶ÊÄùËÄÉ"))return o}return null},findWebSearchButton(){const e=document.querySelector(n.WEB_SEARCH_BTN);if(e)return e;const o=document.querySelectorAll(n.CHAT_INPUT_FEATURE_BTN);for(const e of o){const n=e.querySelector("use");if(n&&n.getAttribute("xlink:href")?.includes("icon-line-globe-01"))return e;if(e.querySelector(".icon-line-globe-01"))return e}for(const e of o){const o=e.querySelector(n.CHAT_INPUT_FEATURE_TEXT);if(o&&o.textContent.includes("ÊêúÁ¥¢"))return e}return null},isFeatureButtonActive(e){if(!e)return!1;if(e.classList.contains("active"))return!0;if("true"===e.getAttribute("aria-pressed"))return!0;if("active"===e.dataset.state||"on"===e.dataset.state)return!0;const n=e.querySelector('i[class*="icon-"]');if(n&&n.classList.contains("icon-fill-deepthink-01"))return!0;if(n&&n.classList.contains("icon-fill-globe-01"))return!0;window.getComputedStyle(e).backgroundColor;return!1},async simulateDeepThinking(e){console.log("[QwenPersona] Setting deep thinking to:",e);const n=l.findDeepThinkingButton();if(!n)return console.warn("[QwenPersona] Deep thinking button not found"),!1;const o=l.isFeatureButtonActive(n);return console.log("[QwenPersona] Deep thinking currently active:",o),o!==e?(n.click(),console.log("[QwenPersona] Clicked deep thinking button"),await r.sleep(100),!0):(console.log("[QwenPersona] Deep thinking already in desired state"),!0)},async simulateWebSearch(e){console.log("[QwenPersona] Setting web search to:",e);const n=l.findWebSearchButton();if(!n)return console.warn("[QwenPersona] Web search button not found"),!1;const o=l.isFeatureButtonActive(n);return console.log("[QwenPersona] Web search currently active:",o),o!==e?(n.click(),console.log("[QwenPersona] Clicked web search button"),await r.sleep(100),!0):(console.log("[QwenPersona] Web search already in desired state"),!0)},async applyFeatureSettings(e){if(!e)return;await r.sleep(200);const n=!0===e.deepThinking;await l.simulateDeepThinking(n);const o=!0===e.webSearch;await l.simulateWebSearch(o)}},d={getCurrentChatId(e=location.pathname){const n=e.match(/\/(?:c|chat)\/([a-zA-Z0-9-]+)/);return n?n[1]:null},setPersonaForCurrentChat(e){const n=d.getCurrentChatId();n&&(e?o.chatPersonaMap[n]=e:delete o.chatPersonaMap[n],a.saveChatPersonaMap(),console.log("[QwenPersona] Mapped chat",n,"to persona",e))},getPersonaForCurrentChat(){const e=d.getCurrentChatId();return e&&o.chatPersonaMap[e]?o.chatPersonaMap[e]:null},startUrlMonitor(){o.lastUrl=location.href,window.addEventListener("popstate",d.handleUrlChange);const e=history.pushState,t=history.replaceState;history.pushState=function(...n){e.apply(this,n),d.handleUrlChange()},history.replaceState=function(...e){t.apply(this,e),d.handleUrlChange()};const r=new MutationObserver(()=>{document.getElementById(n.CONTAINER)||(console.log("[QwenPersona] Dropdown removed, re-injecting..."),s.waitForNavbar())}),a=()=>{const e=document.querySelector(n.HEADER_DESKTOP);e?(r.observe(e,{childList:!0,subtree:!0}),console.log("[QwenPersona] Navbar observer started")):setTimeout(a,500)};a(),console.log("[QwenPersona] URL monitor started")},handleUrlChange(){const e=location.href;if(e===o.lastUrl)return;console.log("[QwenPersona] URL changed:",o.lastUrl,"->",e);const t=d.getCurrentChatId(o.lastUrl),r=d.getCurrentChatId(e);!t&&r&&o.selectedPersonaId&&!o.chatPersonaMap[r]&&(console.log("[QwenPersona] New chat detected, mapping current persona:",o.selectedPersonaId),o.chatPersonaMap[r]=o.selectedPersonaId,a.saveChatPersonaMap()),o.lastUrl=e,setTimeout(()=>{document.getElementById(n.CONTAINER)||(console.log("[QwenPersona] Re-injecting UI after navigation"),s.waitForNavbar()),c.autoSelectPersonaForChat()},300)}},c={selectPersona(e){o.selectedPersonaId=e||null,a.saveSelectedPersona(),s.updateTriggerUI(),s.closeDropdown(),console.log("[QwenPersona] Selected:",e||"None"),d.setPersonaForCurrentChat(e),setTimeout(async()=>{s.setInteractionState(!0);try{if(e){const n=o.personas.find(n=>n.id===e);if(n){if(n.model||n.modelName){const e=n.modelName||n.model;await i.simulateModelSelection(e)}await l.applyFeatureSettings(n)}}else await l.applyFeatureSettings({deepThinking:!1,webSearch:!1})}finally{s.setInteractionState(!1)}},100)},editPersona(e){const n=o.personas.find(n=>n.id===e);n&&s.openModal(n)},deletePersona(e){confirm(t.t("deleteConfirm"))&&(o.personas=o.personas.filter(n=>n.id!==e),a.savePersonas(),o.selectedPersonaId===e&&(o.selectedPersonaId=null,a.saveSelectedPersona(),s.updateTriggerUI()),s.renderDropdownMenu(),console.log("[QwenPersona] Deleted:",e))},savePersonaFromModal(e=null){const t=document.getElementById(n.INPUT_NAME).value.trim(),r=document.getElementById(n.INPUT_EMOJI).value,i=document.getElementById(n.INPUT_MODEL).value,l=document.getElementById(n.INPUT_PROMPT).value.trim(),d=document.getElementById(n.INPUT_DEEP_THINKING).checked,c=document.getElementById(n.INPUT_WEB_SEARCH).checked;if(!t)return void alert("ËØ∑ËæìÂÖ• Persona ÂêçÁß∞");const p=o.availableModels.find(e=>e.id===i),m=p?p.name:"";if(e){const n=o.personas.findIndex(n=>n.id===e);-1!==n&&(o.personas[n]={...o.personas[n],name:t,emoji:r,model:i,modelName:m,prompt:l,deepThinking:d,webSearch:c})}else{const e={id:"persona_"+Date.now(),name:t,emoji:r,model:i,modelName:m,prompt:l,deepThinking:d,webSearch:c,createdAt:Date.now()};o.personas.push(e)}a.savePersonas(),s.updateTriggerUI(),s.closeModal(),console.log("[QwenPersona] Saved persona:",t)},async importFromUrl(e){try{const n=await fetch(e);if(!n.ok)throw new Error("Network response was not ok");const r=await n.json();if(!Array.isArray(r))throw new Error("Invalid JSON format: expected an array");if(!r.every(e=>e.id&&e.name))throw new Error("Invalid persona data");o.personas=r,a.savePersonas(),o.selectedPersonaId&&!o.personas.find(e=>e.id===o.selectedPersonaId)&&(o.selectedPersonaId=null,a.saveSelectedPersona(),s.updateTriggerUI()),s.renderDropdownMenu(),alert(t.t("importSuccess"))}catch(e){console.error("[QwenPersona] Import failed:",e),alert(t.t("importError")+"\n"+e.message)}},autoSelectPersonaForChat(){const e=d.getCurrentChatId();if(!e)return void(o.selectedPersonaId&&(console.log("[QwenPersona] No chat ID (Home/New), resetting to None"),c.selectPersona(null)));const n=o.chatPersonaMap[e];if(n){o.personas.find(e=>e.id===n)?n!==o.selectedPersonaId&&(console.log("[QwenPersona] Auto-selecting persona for chat:",e,"->",n),c.selectPersona(n)):o.selectedPersonaId&&c.selectPersona(null)}else o.selectedPersonaId&&(console.log("[QwenPersona] No mapping for this chat, resetting to None"),c.selectPersona(null))}},p={interceptFetch(){const e=window.fetch;window.fetch=async function(n,t={}){if("string"==typeof n&&n.includes("/api/v2/chat/completions")){const e=o.personas.find(e=>e.id===o.selectedPersonaId);if(e&&t.body)try{let o=JSON.parse(t.body),r=!1;const a=!o.conversation_id&&!o.conversationId&&!o.chat_id||!o.parent_id&&!o.parentId&&o.messages&&1===o.messages.length,s=Array.isArray(o.messages)&&o.messages.some(e=>"system"===e.role);if(console.log("[QwenPersona] Debug - Request Check:",{url:n,isNewChat:a,hasSystemMessage:s,chat_id:o.chat_id,parent_id:o.parent_id||o.parentId,messageCount:o.messages?o.messages.length:0,personaPrompt:!!e.prompt}),e.prompt&&Array.isArray(o.messages)){const n=o.messages.findIndex(e=>"system"===e.role);if(-1!==n){if(console.log("[QwenPersona] Debug - Updating existing System Prompt"),o.messages[n].content=e.prompt,0!==n){const[e]=o.messages.splice(n,1);o.messages.unshift(e)}r=!0}else{if(!o.parent_id&&!o.parentId)console.log("[QwenPersona] Debug - Injecting System Prompt (New Chat/Root)"),o.messages.unshift({role:"system",content:e.prompt}),r=!0;else{console.log("[QwenPersona] Debug - Injecting System Prompt (User Prepend - Continuation)");const n=o.messages[o.messages.length-1];n&&"user"===n.role&&!n.content.startsWith(e.prompt)&&(n.content=`${e.prompt}\n\n${n.content}`,r=!0)}}}e.model&&(o.model=e.model,r=!0),r&&(t.body=JSON.stringify(o),console.log("[QwenPersona] Request modified with persona:",e.name))}catch(e){console.error("[QwenPersona] Failed to modify request:",e)}}return e.call(this,n,t)},console.log("[QwenPersona] Fetch intercepted")}};function m(){console.log("[QwenPersona] Initializing..."),t.init(),a.loadPersonas(),a.loadSelectedPersona(),a.loadChatPersonaMap(),i.fetchModels(),s.injectStyles(),s.createModalUI();const e=document.createElement("script");e.type="module",e.src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js",document.head.appendChild(e),p.interceptFetch(),s.waitForNavbar(),d.startUrlMonitor(),window.personaManager={closeModal:s.closeModal,openModal:s.openModal,refresh:()=>{a.loadPersonas(),a.loadSelectedPersona(),s.updateTriggerUI()}},document.addEventListener("click",e=>{const o=document.getElementById(n.CONTAINER),t=document.getElementById(n.MENU),r=o&&o.contains(e.target),a=t&&t.contains(e.target);r||a||s.closeDropdown();const i=document.getElementById("persona-emoji-picker"),l=document.getElementById("persona-emoji-trigger-btn");i&&l&&(i.contains(e.target)||l.contains(e.target)||i.classList.remove("visible"))})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",m):m()}();
